#!/usr/bin/env bash

set -e  # Exit on error

echo ""
echo "╔════════════════════════════════════════════════╗"
echo "║     Lean Scout Test Suite (Four Phases)        ║"
echo "╚════════════════════════════════════════════════╝"

# Ensure test_project uses the same Lean toolchain as the repo root
ROOT_TOOLCHAIN=$(cat lean-toolchain | tr -d '[:space:]')
TEST_PROJECT_TOOLCHAIN=$(cat test_project/lean-toolchain | tr -d '[:space:]')

if [ "$ROOT_TOOLCHAIN" != "$TEST_PROJECT_TOOLCHAIN" ]; then
  echo "Error: test_project/lean-toolchain ($TEST_PROJECT_TOOLCHAIN) does not match root lean-toolchain ($ROOT_TOOLCHAIN)."
  echo "Please update test_project/lean-toolchain to match the root toolchain."
  exit 1
fi

echo ""
echo "=== Phase 0: Lean Schema Tests ==="
echo "Testing schema serialization/deserialization roundtrip"
lake test

echo ""
echo "=== Phase 1: Python Parquet Writer Tests ==="
echo "Testing ShardedParquetWriter and schema utilities"
uv run pytest test/internals/ -v --cov=lean_scout --cov-report=term-missing

echo ""
echo "=== Phase 2: Lean Orchestrator Integration Tests ==="
echo "Testing CLI argument handling and orchestration"
./test/integration/test_lean_orchestrator.sh

echo ""
echo "=== Phase 3: End-to-End Extractor Tests ==="
echo "Testing data extraction pipeline using test_project"
uv run pytest test/extractors/ -v

echo ""
echo "╔════════════════════════════════════════════════╗"
echo "║          All Tests Passed! ✓                   ║"
echo "╚════════════════════════════════════════════════╝"
