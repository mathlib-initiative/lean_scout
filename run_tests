#!/usr/bin/env bash

set -e  # Exit on error

echo ""
echo "╔════════════════════════════════════════════════╗"
echo "║     Lean Scout Test Suite (Seven Phases)       ║"
echo "╚════════════════════════════════════════════════╝"

# Ensure test_project uses the same Lean toolchain as the repo root
ROOT_TOOLCHAIN=$(cat lean-toolchain | tr -d '[:space:]')
TEST_PROJECT_TOOLCHAIN=$(cat test_project/lean-toolchain | tr -d '[:space:]')

if [ "$ROOT_TOOLCHAIN" != "$TEST_PROJECT_TOOLCHAIN" ]; then
  echo "Error: test_project/lean-toolchain ($TEST_PROJECT_TOOLCHAIN) does not match root lean-toolchain ($ROOT_TOOLCHAIN)."
  echo "Please update test_project/lean-toolchain to match the root toolchain."
  exit 1
fi

echo ""
echo "=== Phase 0: Linting ==="
echo "Running ruff linter on Python code"
uv run ruff check src/ test/

echo ""
echo "=== Phase 1: Type Checking ==="
echo "Running mypy on Python code"
uv run mypy src/

echo ""
echo "=== Phase 2: Lean Schema Tests ==="
echo "Testing schema serialization/deserialization roundtrip"
lake test

echo ""
echo "=== Phase 3: Build Test Project ==="
echo "Building test_project for integration tests"
(cd test_project && lake build)

echo ""
echo "=== Phase 4: Python Parquet Writer Tests ==="
echo "Testing ShardedParquetWriter and schema utilities"
uv run pytest test/internals/ -v --cov=lean_scout --cov-report=term-missing

echo ""
echo "=== Phase 5: Lean Orchestrator Integration Tests ==="
echo "Testing CLI argument handling and orchestration"
./test/integration/test_lean_orchestrator.sh

echo ""
echo "=== Phase 6: End-to-End Extractor Tests ==="
echo "Testing data extraction pipeline using test_project"
uv run pytest test/extractors/ -v

echo ""
echo "╔════════════════════════════════════════════════╗"
echo "║          All Tests Passed! ✓                   ║"
echo "╚════════════════════════════════════════════════╝"
